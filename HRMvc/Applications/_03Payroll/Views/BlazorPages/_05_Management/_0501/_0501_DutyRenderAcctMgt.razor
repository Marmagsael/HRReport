@using HRApiLibrary.DataAccess._20_Pay
@using HRApiLibrary.DataAccess._20_Pay.Interface
@using HRApiLibrary.Models._20_Pay



<div class="msds-modal">
    <div class="msds-modal-content" style="max-width: 980px;">
        <div class="modal-content  bg-opacity-75">
            <div class="modal-header  bg-opacity-75">
                <h1 class="modal-title fs-5">Rendered Duty Accounts List</h1>
                <button type="button" class="btn-close" @onclick="@(()=>ShowHideSearchModal(false))" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                @*--- Header  *@
                <div class="d-flex p-2 fw-bolder bordered ">
                    <div class="w-100p">Acct. Coder</div>
                    <div class="w-250p">Acct. Name</div>
                    <div class=""> </div>
                        
                </div>
                
                @{ 
                    var sw = true;
                    var bg = " "; 
                }
                
                <div class="bordered " style="max-height: 50vh; overflow-y: auto;">
                    @foreach (var c in coas)
                    {
                        sw = !sw;
                        bg = (!sw) ? " bg-gray-95 " : " bg-gray-90 ";
                        
                        <div class="d-flex px-2 py-1 @bg " >
                            <div class="w-100p">@c?.AcctNumber</div>
                            <div class="w-250p">@c?.AcctName</div>
                            <div class="d-flex gap-1 ">
                                <div class=" @((c?.IsLockB??false) ? " disabled-div " : "") w-100 text-center ">
                                    @* <input @onchange="AcctChanged" class="form-check-input" type="checkbox" @bind="@c!.IsSelectedB"/>     *@
                                    <input 
                                        class="form-check-input" 
                                        type="checkbox"
                                        checked="@c!.IsSelectedB"
                                        @onchange="@((ChangeEventArgs e) => AcctChanged(e, c))" />

                                </div>
                            </div>
                        
                        </div>
                        
                    }    
                </div>
                
                
                
                
                
                
            </div>

        </div>
    </div>
</div>

@inject ICoaDataAccess          _coa; 
@inject IDutyrenderedDataAccess _dr; 



@code {
    
    [Parameter] public UserClaimsModel          UserClaims      { get; set; } = new();
    [Parameter] public EventCallback<bool>      ChildAction     { get; set; }

    List<CoaModel?>? coas = []; 
        
    string? pisdb               = string.Empty;
    string? paydb               = string.Empty;
    string? conn                = string.Empty;
    bool    notRerender         = true; 
    
    protected override async void OnParametersSet()
    {
        if(UserClaims==null) return;
        pisdb = UserClaims.SchemaUserPis;
        paydb = UserClaims.SchemaUserPay;
        conn = UserClaims.Conn;

        if (conn == null ) return;
        if (pisdb == null ) return;
        if (paydb == null) return;

        if(notRerender) await LoadCoa(); 
    }
    
    async Task ShowHideSearchModal(bool action)
    {
        await ChildAction.InvokeAsync(action);
    }

    async Task LoadCoa()
    {
        coas = await _coa._02_Earnings(paydb!, conn!); 
        coas?.ForEach(c =>
        {
            if (c == null) return;
            c.IsSelectedB   = false;    
            c.IsLockB       = false;
        });

        var drs = await _dr._02s(paydb!, conn!);
        foreach (var dr in drs??[])
        {
            if (coas == null) continue;
            foreach (var coa in coas.Where(coa => coa?.AcctNumber == dr?.AcctNumber))
            {
                if (coa == null) continue;
                coa.IsSelectedB = true;
                if (dr!.IsLock == 1) coa.IsLockB = true;
            }
        }
        
        notRerender = false; 
        StateHasChanged();
    }


    private async Task AcctChanged(ChangeEventArgs e, CoaModel c)
    {
        var val = (bool)(e.Value??false); 
        c.IsSelectedB = val;
        
        var dr = new DutyrenderedModel() { AcctNumber = c.AcctNumber, AcctName = c.AcctName, IsLock = c.IsLock };
        if (val) await _dr._01(dr, paydb!, conn!);
        else await _dr._04(c.AcctNumber??"", paydb!, conn!); 
        
    }

}