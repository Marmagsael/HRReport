@using HRApiLibrary.DataAccess._20_Pay
@using HRApiLibrary.Models._00_Main
@using HRApiLibrary.Models._20_Pay
@using HRMvc.Applications._03Payroll.Views.BlazorPages._00_Utility.Vars
@using HRMvc.Applications.PayrollReport.Views.Blazor.Components

@using Telerik.ReportViewer.Blazor
@using Telerik.Reporting

<Rep_SubHdr HdrText="Earnings Summary Report"   />

<div class="card-body">
    <div class="d-flex gap-2 mb-3">
        <button class="btn btn-primary" @onclick="GenerateReport">Generate Report</button>
    </div>

    @if (isLoading)
    {
        <p class="text-info mt-2">Generating report, please wait...</p>
    }

    @if (ReportSourceOptions != null)
    {
        <div style="height:800px; width:100%;">
            <ReportViewer ServiceUrl="/api/reports" ReportSource="@ReportSourceOptions" />
        </div>
    }
</div>

@inject ICoaDataAccess _coa; 

@code {
    private string      selectedReport  = "Reports/Coa.trdp";
    private bool        isLoading       = false;
    private string?     paydb;
    private string?     conn;

    List<CoaModel?>?    coas            = [];

    private ReportSourceOptions? ReportSourceOptions;

    [Parameter] public UserClaimsModel?     UserClaims      { get; set; }
    [Parameter] public V00_Pay              V00             { get; set; } = new();

    protected override void OnParametersSet()
    {
        SetVariables();
    }

    private async void SetVariables()
    {
        try
        {
            V00.UserClaims  = UserClaims;
            paydb           = UserClaims!.SchemaUserPay;
            conn            = UserClaims!.Conn;
            StateHasChanged();
        }
        catch (Exception ex) { Console.WriteLine($"[PayrollReport] Initialization failed: {ex.Message}"); }
    }

    private async Task GenerateReport()
    {
        try
        {
            isLoading = true;
            ReportSourceOptions = null;
            StateHasChanged();

            // ✅ Step 1: Load your data (if needed)
            coas = await _coa._02(paydb!, conn!); 
            // ✅ Step 2: Assign report dynamically
            ReportSourceOptions = new ReportSourceOptions
            {
                Report = selectedReport
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[PayrollRegister] Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
